name: Build WSL Image

on:
  workflow_dispatch:
    inputs:
      ubuntuVersion:
        description: 'Ubuntu Version'
        required: true
        default: 'jammy'
        type: choice
        options:
          - jammy
          - noble
          
      customPackages:
        description: 'Custom Packages (comma-separated)'
        required: false
        default: ''

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Docker
        uses: docker/setup-buildx-action@v2

      - name: Build WSL Image
        env:
          # 定义变量
          UBUNTU_VERSION: ${{ github.event.inputs.ubuntuVersion }}
          CUSTOM_PACKAGES: ${{ github.event.inputs.customPackages }}
          IMAGE_NAME: "wsl-${UBUNTU_VERSION}-image"
        run: |
          

          # 创建 Dockerfile
          cat <<EOF > Dockerfile
          FROM ubuntu:${UBUNTU_VERSION}
          ADD script.sh /script.sh
          RUN chmod +x /script.sh && /script.sh
          CMD /usr/sbin/init
          EOF

          # 构建 Docker 镜像
          docker build -t ${IMAGE_NAME} .

          # 导出为 WSL 镜像
          docker run --name wsl-container ${IMAGE_NAME}
          docker export wsl-container > ${IMAGE_NAME}.tar
          docker rm wsl-container

      - name: Split WSL Image
        run: |
          IMAGE_NAME="wsl-${UBUNTU_VERSION}-image"
          SPLIT_SIZE=1073741824  # 1GB in bytes
          mkdir -p split_images
          split -b ${SPLIT_SIZE} ${IMAGE_NAME}.tar split_images/${IMAGE_NAME}-part_

      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: "run-${{ github.run_id }}"
          release_name: "WSL Image for Ubuntu ${UBUNTU_VERSION} (Run ID: ${{ github.run_id }})"
          body: "This release contains the WSL image for Ubuntu ${UBUNTU_VERSION}."
          draft: false
          prerelease: false
          generate_release_notes: true
          files: |
            split_images/${IMAGE_NAME}-part_*

      
